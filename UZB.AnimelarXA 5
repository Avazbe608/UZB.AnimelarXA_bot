import os
import json
from pathlib import Path
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

# --- CONFIG ---
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("‚ùå BOT_TOKEN environment variable topilmadi!")

ADMIN_ID = 7633032473  # <-- O'zingizning Telegram ID
DATA_FILE = Path("/data/anime_db.json")
DATA_FILE.parent.mkdir(parents=True, exist_ok=True)
PAGE_SIZE = 5
EPISODE_PAGE_SIZE = 12

# --- MA'LUMOTLARNI SAQLASH/OLISH ---
def load_data():
    if not DATA_FILE.exists():
        save_data({})
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except json.JSONDecodeError:
        save_data({})
        return {}

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    with open("/data/backup_anime_db.json", "w", encoding="utf-8") as backup:
        json.dump(data, backup, ensure_ascii=False, indent=2)

# --- PAGINATION FUNKSIYALAR ---
def get_page_buttons(data, page=0):
    titles = list(data.keys())
    start = page * PAGE_SIZE
    end = start + PAGE_SIZE
    keyboard = [[InlineKeyboardButton(t, callback_data=f"show_{t}")] for t in titles[start:end]]
    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è Oldingi", callback_data=f"page_{page-1}"))
    if end < len(titles):
        nav_buttons.append(InlineKeyboardButton("Keyingi ‚ñ∂Ô∏è", callback_data=f"page_{page+1}"))
    if nav_buttons:
        keyboard.append(nav_buttons)
    return InlineKeyboardMarkup(keyboard)

def get_episode_buttons(anime, title, page=0):
    eps_list = list(anime.get("episodes", {}).keys())
    keyboard = []

    if not eps_list:
        keyboard.append([InlineKeyboardButton("üéûÔ∏è Epizod qo‚Äòshish", callback_data=f"add_ep_{title}")])
    else:
        start = page * EPISODE_PAGE_SIZE
        end = start + EPISODE_PAGE_SIZE
        for ep in eps_list[start:end]:
            keyboard.append([
                InlineKeyboardButton(f"üé• Epizod {ep}", callback_data=f"ep_{title}_{ep}"),
                InlineKeyboardButton("‚úèÔ∏è", callback_data=f"edit_ep_{title}_{ep}"),
                InlineKeyboardButton("üóëÔ∏è", callback_data=f"del_ep_{title}_{ep}")
            ])
        nav_buttons = []
        if page > 0:
            nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è Oldingi", callback_data=f"ep_page_{title}_{page-1}"))
        if end < len(eps_list):
            nav_buttons.append(InlineKeyboardButton("Keyingi ‚ñ∂Ô∏è", callback_data=f"ep_page_{title}_{page+1}"))
        if nav_buttons:
            keyboard.append(nav_buttons)
        keyboard.append([InlineKeyboardButton("üéûÔ∏è Yangi epizod qo‚Äòshish", callback_data=f"add_ep_{title}")])

    # Admin uchun "üõ†Ô∏è Tahrirlash" menyusi
    keyboard.append([InlineKeyboardButton("üõ†Ô∏è Anime ma‚Äôlumotlarini tahrirlash", callback_data=f"edit_anime_{title}")])
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è Orqaga", callback_data="anime_list")])
    return InlineKeyboardMarkup(keyboard)

# --- START ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üëã Xush kelibsiz!\n\nBuyruqlar:\n"
        "/anime - Anime ro‚Äòyxati\n"
        "/addanime - Yangi anime qo‚Äòshish (admin)\n"
        "/deleteanime - Anime o‚Äòchirish (admin)"
    )

# --- ANIME RO‚ÄòYXATI ---
async def anime_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_data()
    if not data:
        await update.message.reply_text("üì≠ Hozircha anime mavjud emas.")
        return
    await update.message.reply_text("üé¨ Anime tanlang:", reply_markup=get_page_buttons(data, 0))

# --- ANIME QO‚ÄòSHISH ---
ANIME_FIELDS = ["image", "title", "description", "year", "country", "language", "genre", "watch_link"]

async def addanime_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.id != ADMIN_ID:
        await update.message.reply_text("‚õî Sizda bu buyruqdan foydalanish huquqi yo‚Äòq.")
        return

    context.user_data["new_anime"] = {f: None for f in ANIME_FIELDS}
    context.user_data["new_anime"]["episodes"] = {}

    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è Rasm URL", callback_data="new_image")],
        [InlineKeyboardButton("üè∑Ô∏è Nomi", callback_data="new_title")],
        [InlineKeyboardButton("üìù Tavsif", callback_data="new_description")],
        [InlineKeyboardButton("üìÜ Yili", callback_data="new_year")],
        [InlineKeyboardButton("üåç Davlati", callback_data="new_country")],
        [InlineKeyboardButton("üó£Ô∏è Tili", callback_data="new_language")],
        [InlineKeyboardButton("üé≠ Janr", callback_data="new_genre")],
        [InlineKeyboardButton("‚ñ∂Ô∏è Tomosha havolasi", callback_data="new_watch_link")],
        [InlineKeyboardButton("üéûÔ∏è Epizod qo‚Äòshish", callback_data="new_episodes")],
        [InlineKeyboardButton("‚úÖ Saqlash", callback_data="new_save")]
    ]

    await update.message.reply_text(
        "üÜï Yangi anime yaratish!\nQuyidagi tugmalardan foydalaning:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def addanime_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "new_episodes":
        context.user_data["adding_episode"] = True
        await query.message.reply_text("üéûÔ∏è Epizod raqamini kiriting:")
        return

    if data == "new_save":
        new_anime = context.user_data.get("new_anime", {})
        if not new_anime.get("title"):
            await query.message.reply_text("‚ö†Ô∏è Avvalo anime nomini kiriting!")
            return

        db = load_data()
        db[new_anime["title"]] = new_anime
        save_data(db)
        await query.message.reply_text(f"‚úÖ *{new_anime['title']}* saqlandi!", parse_mode="Markdown")
        context.user_data.clear()
        return

    field = data.replace("new_", "")
    context.user_data["current_field"] = field
    await query.message.reply_text(f"‚úçÔ∏è {field} uchun qiymat kiriting:")

async def handle_new_anime_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # Epizod qo‚Äòshish jarayoni
    if context.user_data.get("adding_episode"):
        if "current_episode" not in context.user_data:
            context.user_data["current_episode"] = update.message.text
            await update.message.reply_text("üîó Endi shu epizod uchun video URL kiriting:")
        else:
            ep_num = context.user_data["current_episode"]
            ep_link = update.message.text
            context.user_data["new_anime"]["episodes"][ep_num] = ep_link
            context.user_data.pop("current_episode")
            await update.message.reply_text(f"‚úÖ Epizod {ep_num} qo‚Äòshildi! /done bilan tugating.")
        return

    if update.message.text.lower() == "/done":
        context.user_data.pop("adding_episode", None)
        await update.message.reply_text("‚úÖ Epizodlar qo‚Äòshish yakunlandi!")
        return

    # Oddiy maydon
    field = context.user_data.get("current_field")
    if not field:
        return
    value = update.message.text
    context.user_data["new_anime"][field] = value
    context.user_data["current_field"] = None
    await update.message.reply_text(f"‚úÖ {field} saqlandi!")

# --- CALLBACKLAR ---
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    db = load_data()
    data = query.data

    # Orqaga
    if data == "anime_list":
        await query.edit_message_text("üé¨ Anime tanlang:", reply_markup=get_page_buttons(db, 0))
        return

    # Anime ko‚Äòrsatish
    if data.startswith("show_"):
        title = data[5:]
        anime = db.get(title)
        if anime:
            caption = (
                f"üé¨ *{title}*\n\n"
                f"üìù {anime.get('description','Tavsif yo‚Äòq')}\n"
                f"üé≠ {anime.get('genre','?')}\n"
                f"üìÜ {anime.get('year','?')} | üåç {anime.get('country','?')} | üó£Ô∏è {anime.get('language','?')}\n"
                f"‚ñ∂Ô∏è [Tomosha qilish]({anime.get('watch_link','')})"
            )
            await query.message.reply_photo(
                photo=anime.get("image",""),
                caption=caption,
                parse_mode="Markdown",
                reply_markup=get_episode_buttons(anime, title)
            )

    # Anime tahrirlash menyusi
    elif data.startswith("edit_anime_"):
        title = data.replace("edit_anime_", "")
        context.user_data["edit_title"] = title
        keyboard = [
            [InlineKeyboardButton("üñºÔ∏è Rasm", callback_data="edit_field_image")],
            [InlineKeyboardButton("üìù Tavsif", callback_data="edit_field_description")],
            [InlineKeyboardButton("üìÜ Yil", callback_data="edit_field_year")],
            [InlineKeyboardButton("üåç Davlat", callback_data="edit_field_country")],
            [InlineKeyboardButton("üó£Ô∏è Til", callback_data="edit_field_language")],
            [InlineKeyboardButton("üé≠ Janr", callback_data="edit_field_genre")],
            [InlineKeyboardButton("‚ñ∂Ô∏è Tomosha havolasi", callback_data="edit_field_watch_link")],
            [InlineKeyboardButton("‚¨ÖÔ∏è Orqaga", callback_data=f"show_{title}")]
        ]
        await query.message.reply_text(f"üõ†Ô∏è *{title}* ma‚Äôlumotlarini tahrirlash:", parse_mode="Markdown",
                                       reply_markup=InlineKeyboardMarkup(keyboard))

    # Tahrirlanadigan maydon tanlandi
    elif data.startswith("edit_field_"):
        field = data.replace("edit_field_", "")
        context.user_data["editing_field"] = field
        await query.message.reply_text(f"‚úèÔ∏è {field} uchun yangi qiymat kiriting:")

    # Epizodlar / o‚Äòchirish / tahrirlash qolgan kodlari avvalgidek
    elif data.startswith("add_ep_") or data.startswith("edit_ep_") or data.startswith("del_ep_") or data.startswith("ep_"):
        await handle_episode_actions(update, context)

async def handle_episode_actions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    db = load_data()

    if data.startswith("add_ep_"):
        title = data.replace("add_ep_", "")
        context.user_data["add_ep_title"] = title
        context.user_data["adding_new_episode"] = True
        await query.message.reply_text(f"üéûÔ∏è {title} uchun epizod raqamini kiriting:")

    elif data.startswith("edit_ep_"):
        _, title, ep = data.split("_", 2)
        context.user_data.update({
            "edit_ep_title": title,
            "edit_ep_number": ep,
            "editing_episode": True
        })
        await query.message.reply_text(f"‚úèÔ∏è Epizod {ep} uchun yangi URL kiriting:")

    elif data.startswith("del_ep_"):
        _, title, ep = data.split("_", 2)
        if ep in db[title]["episodes"]:
            del db[title]["episodes"][ep]
            save_data(db)
            await query.message.reply_text(f"üóëÔ∏è {title} - {ep}-epizod o‚Äòchirildi!")

    elif data.startswith("ep_"):
        _, title, ep = data.split("_", 2)
        await query.message.reply_video(
            video=db[title]["episodes"][ep],
            caption=f"üé¨ {title} - Epizod {ep}",
            parse_mode="Markdown"
        )

# --- MATN KIRITISH (TAHRIRLASH) ---
async def handle_text_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    db = load_data()
    text = update.message.text

    # Epizod tahrirlash yoki qo‚Äòshish
    if context.user_data.get("adding_new_episode") or context.user_data.get("editing_episode"):
        for key in ["adding_new_episode", "editing_episode"]:
            if context.user_data.get(key):
                await handle_episode_text(update, context)
                return

    # Anime maydoni tahrirlash
    if "editing_field" in context.user_data and "edit_title" in context.user_data:
        title = context.user_data["edit_title"]
        field = context.user_data["editing_field"]
        db[title][field] = text
        save_data(db)
        await update.message.reply_text(f"‚úÖ {title} uchun {field} yangilandi!")
        context.user_data.clear()

async def handle_episode_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    db = load_data()
    text = update.message.text

    if context.user_data.get("adding_new_episode"):
        title = context.user_data["add_ep_title"]
        if "current_add_ep" not in context.user_data:
            context.user_data["current_add_ep"] = text
            await update.message.reply_text("üîó Endi video URL kiriting:")
        else:
            ep = context.user_data["current_add_ep"]
            db[title]["episodes"][ep] = text
            save_data(db)
            await update.message.reply_text(f"‚úÖ {title} - {ep}-epizod qo‚Äòshildi!")
            context.user_data.clear()

    elif context.user_data.get("editing_episode"):
        title = context.user_data["edit_ep_title"]
        ep = context.user_data["edit_ep_number"]
        db[title]["episodes"][ep] = text
        save_data(db)
        await update.message.reply_text(f"‚úèÔ∏è {title} - {ep}-epizod yangilandi!")
        context.user_data.clear()

# --- DELETE ANIME ---
async def delete_anime(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.id != ADMIN_ID:
        await update.message.reply_text("‚õî Sizda bu buyruqdan foydalanish huquqi yo‚Äòq.")
        return
    data = load_data()
    if not data:
        await update.message.reply_text("üì≠ Hech qanday anime yo‚Äòq.")
        return
    keyboard = [[InlineKeyboardButton(t, callback_data=f"del_{t}")] for t in data.keys()]
    await update.message.reply_text("üóëÔ∏è O‚Äòchirish uchun anime tanlang:", reply_markup=InlineKeyboardMarkup(keyboard))

# --- RUN ---
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("anime", anime_list))
    app.add_handler(CommandHandler("addanime", addanime_start))
    app.add_handler(CommandHandler("deleteanime", delete_anime))
    app.add_handler(CallbackQueryHandler(addanime_buttons, pattern="^new_"))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_new_anime_input))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_input))

    print("‚úÖ Bot ishga tushdi!")
    app.run_polling()

if __name__ == "__main__":
    main()
